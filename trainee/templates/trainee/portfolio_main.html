

{% extends 'trainee/portfolio.html' %}

{% load static %}


{% block portfolio_content %}
<div class="row">
    <div class="col-md-12">
        <div class="box box-solid">
            <div class="box-header with-border">
                <h3 class="box-title">Competency Progress</h3>
            </div>
            <div class="box-body">
                {% regroup competencies by category as grouped_competencies %}
                {% for category in grouped_competencies %}
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <h3 class="box-title">{{ category.grouper }}</h3>
                        </div>
                        <div class="box-body">
                        {% for competency in category.list %}
                        {% with status=competency_status.competency.id %}
                                <div class="competency-card {{ status }}">
                                    <div class="pull-right">
                                        <span class="status-badge status-{{ status }}">                                 {{ status|title }}
                                </span>
                            </div>
                            <h4>{{ competency.name }}</h4>
                            <p class="text-muted">{{ competency.description }}</p>
                            <div class="progress">
                                <div class="progress-bar 
                                    {% if status == 'competent' %}bg-green
                                    {% elif status == 'in-progress' %}bg-yellow
                                    {% elif status == 'needs-review' %}bg-orange
                                    {% else %}bg-gray{% endif %}" 
                                    style="width: 
                                    {% if status == 'competent' %}85%
                                    {% elif status == 'in-progress' %}50%
                                    {% elif status == 'needs-review' %}75%
                                    {% else %}10%{% endif %}">
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Recent Evidence</h3>
            </div>
            <div class="box-body">
                {% for evidence in recent_evidence %}
                <div class="attachment-block clearfix">
                    {% if evidence.evidence_type == 'image' %}
                    <img class="attachment-img" src="{{ evidence.file.url }}" alt="{{ evidence.title }}">
                    {% else %}
                    <div class="attachment-pdf">
                        <i class="fa fa-file-{{ evidence.evidence_type }}-o"></i>
                    </div>
                    {% endif %}
                    <div class="attachment-info">
                        <h4 class="attachment-heading">
                            <a href="#">{{ evidence.title }}</a>
                        </h4>
                        <div class="attachment-text">
                            {{ evidence.description|truncatewords:10 }}
                        </div>
                        <span class="attachment-date">
                            <i class="fa fa-clock-o"></i> {{ evidence.upload_date|date:"M d, Y" }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No evidence uploaded yet.</p>
                {% endfor %}
            </div>
            <div class="box-footer text-center">
                <a href="{% url 'trainee:portfolio_evidence' %}" class="btn btn-sm btn-default">
                    View All Evidence
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">Recent Assessments</h3>
            </div>
            <div class="box-body">
                {% for assessment in recent_assessments %}
                <div class="post">
                    <div class="user-block">
                        <img class="img-circle img-bordered-sm" src="{% static 'dist/img/user1-128x128.jpg' %}" alt="User Image">
                        <span class="username">
                            <a href="#">{{ assessment.assessor.get_full_name }}</a>
                        </span>
                        <span class="description">
                            Assessed {{ assessment.assessment_date|timesince }} ago
                        </span>
                    </div>
                    <p>
                        <strong>{{ assessment.evidence.title }}</strong><br>
                        Status: 
                        <span class="label 
                            {% if assessment.status == 'approved' %}label-success
                            {% elif assessment.status == 'needs_revision' %}label-warning
                            {% else %}label-default{% endif %}">
                            {{ assessment.get_status_display }}
                        </span>
                    </p>
                    {% if assessment.feedback %}
                    <p class="text-muted">{{ assessment.feedback|truncatewords:20 }}</p>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No assessments yet.</p>
                {% endfor %}
            </div>
        </div>

        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">Share Your Portfolio</h3>
            </div>
            <div class="box-body">
                {% if share_link %}
                <div class="share-link-box">
                    <p>Your portfolio is shared with this link:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ share_link }}" id="shareLink">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" onclick="copyShareLink()">
                                <i class="fa fa-copy"></i>
                            </button>
                        </span>
                    </div>
                    <small class="text-muted">Anyone with this link can view your portfolio</small>
                </div>
                <form method="post" action="{% url 'trainee:portfolio_share' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate">
                    <button type="submit" class="btn btn-warning btn-block">
                        <i class="fa fa-times"></i> Deactivate Share Link
                    </button>
                </form>
                {% else %}
                <p>Share your portfolio with others via a public link.</p>
                <form method="post" action="{% url 'trainee:portfolio_share' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create">
                    <div class="form-group">
                        <label>Link Expires After (days)</label>
                        <select class="form-control" name="expires">
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                            <option value="365">1 year</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fa fa-share"></i> Create Share Link
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function copyShareLink() {
    var copyText = document.getElementById("shareLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Copied share link: " + copyText.value);
}
</script>
{% endblock %}