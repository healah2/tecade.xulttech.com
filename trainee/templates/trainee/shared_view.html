<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Assessment - {{ trainee.get_full_name }}</title>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- AdminLTE 3 & Bootstrap 4 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root {
      --primary-color: #2c5aa0;
      --secondary-color: #4a6fa5;
      --background-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --header-bg: #2c5aa0;
      --header-text: #FFFFFF;
      --success-color: #388e3c;
      --danger-color: #d32f2f;
      --accent-color: #1976d2;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
    }
    
    .dark-mode {
      --primary-color: #4a76b0;
      --secondary-color: #5a86c0;
      --background-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --border-color: #333333;
      --header-bg: #1a365d;
      --header-text: #e0e0e0;
      --success-color: #4caf50;
      --danger-color: #f44336;
      --accent-color: #2196f3;
      --light-gray: #2d2d2d;
      --medium-gray: #444444;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      transition: all 0.3s ease;
      line-height: 1.5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .card-header {
      background-color: var(--header-bg);
      color: var(--header-text);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
      padding: 12px 15px;
    }
    
    .card-body {
      padding: 15px;
    }
    
    .table th {
      background-color: var(--light-gray);
      color: var(--text-color);
      font-weight: 500;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table td {
      border-bottom: 1px solid var(--border-color);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    
    .btn-outline-success {
      color: var(--success-color);
      border-color: var(--success-color);
    }
    
    .btn-outline-success:hover {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-outline-danger {
      color: var(--danger-color);
      border-color: var(--danger-color);
    }
    
    .btn-outline-danger:hover {
      background-color: var(--danger-color);
      color: white;
    }
    
    .save-btn {
      display: block;
      margin: 20px auto;
      font-weight: 500;
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      background-color: var(--primary-color);
      color: white;
    }
    
    .dark-mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .header {
      background-color: var(--header-bg);
      color: var(--header-text);
      padding: 15px 0;
      margin-bottom: 25px;
      border-radius: 6px;
    }
    
    .footer {
      background-color: var(--header-bg);
      color: var(--header-text);
      padding: 15px 0;
      margin-top: 30px;
      border-radius: 6px;
      text-align: center;
    }
    
    .assessment-progress {
      background-color: var(--light-gray);
      color: var(--text-color);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .progress {
      background-color: var(--medium-gray);
      height: 8px;
    }
    
    .progress-bar {
      background-color: var(--primary-color);
    }
    
    .evidence-assessment {
      padding: 15px;
      background: var(--light-gray);
      border-radius: 6px;
      margin-bottom: 15px;
    }
    
    .btn-assessment {
      border-radius: 4px;
      padding: 6px 12px;
      font-weight: 500;
    }
    
    .view-toggle {
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      font-size: 14px;
    }
    
    .view-toggle.active {
      background: var(--primary-color);
      color: white;
    }
    
    .evidence-card {
      transition: all 0.2s;
      border-left: 3px solid var(--primary-color);
    }
    
    .evidence-card:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--text-color);
      font-weight: 500;
    }
    
    .text-primary {
      color: var(--primary-color) !important;
    }
    
    .text-success {
      color: var(--success-color) !important;
    }
    
    .text-danger {
      color: var(--danger-color) !important;
    }
    
    .text-muted {
      color: #6c757d !important;
    }
    
    .form-control {
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .custom-control-input:checked ~ .custom-control-label::before {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .border-left-info {
      border-left: 3px solid var(--accent-color);
    }
    
    .border-warning {
      border-color: #ffc107 !important;
    }
    
    .bg-warning {
      background-color: #ffc107 !important;
    }
  </style>
</head>

<body>
  <!-- Dark Mode Toggle -->
  <div class="dark-mode-toggle" id="darkModeToggle">
    <i class="fas fa-moon"></i>
  </div>
  
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h3 class="mb-0"><i class="fas fa-user-graduate mr-2"></i>Portfolio Assessment</h3>
        </div>
        <div class="col-md-6 text-right">
          <h5 class="mb-0">{{ trainee.get_full_name }}</h5>
          <small>ID: {{ trainee.username }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Assessor Info Modal -->
  <div class="modal fade" id="assessorModal" tabindex="-1" role="dialog" aria-labelledby="assessorModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assessorModalLabel">Assessor Information</h5>
        </div>
        <div class="modal-body">
          <form id="assessorForm">
            <div class="form-group">
              <label for="assessorName">Assessor Name</label>
              <input type="text" class="form-control" id="assessorName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
              <label for="assessmentDateTime">Assessment Date & Time</label>
              <input type="datetime-local" class="form-control" id="assessmentDateTime" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary btn-block" id="startAssessmentBtn">
            Start Assessment
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Assessment Content -->
  <div class="container fade-in" id="assessmentContent" style="display:none;">
    <!-- Assessment Progress -->
    <div class="assessment-progress">
      <div class="row">
        <div class="col-md-4">
          <h5>{{ trainee.get_full_name }}</h5>
          <small>Trainee #{{ trainee.username }}</small>
        </div>
        <div class="col-md-4 text-center">
          <h5 id="progressText">0/0 Evidence Assessed</h5>
          <div class="progress">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="col-md-4 text-right">
          <h6 id="currentAssessor"></h6>
          <small id="assessmentTime"></small>
        </div>
      </div>
    </div>

    <!-- Trainee Information -->
    <div class="card mb-4 fade-in">
      <div class="card-header">
        <h5 class="card-title mb-0">Trainee Portfolio</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Name:</strong> {{ trainee.get_full_name }}</p>
            <p><strong>Trainee Number:</strong> {{ trainee.username }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Email:</strong> {{ trainee.email }}</p>
            <p><strong>Assessment Started:</strong> <span id="assessmentTimeDisplay"></span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- View Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Portfolio Evidence</h4>
      <div class="btn-group">
        <span class="view-toggle active" onclick="toggleView('list')">
          <i class="fas fa-list mr-1"></i> List View
        </span>
        <span class="view-toggle" onclick="toggleView('grid')">
          <i class="fas fa-th-large mr-1"></i> Grid View
        </span>
      </div>
    </div>

    <!-- Evidence Artifacts with Assessment -->
    <div class="card mb-4 fade-in">
      <div class="card-header">
        <h6 class="mb-0">Evidence & Reflections</h6>
      </div>
      <div class="card-body">
        <div id="evidenceContainer" class="list-view">
          {% for evidence in evidence_list %}
          <div class="evidence-card card mb-3">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="card-title text-primary">{{ evidence.title }}</h5>
                  <p class="card-text">{{ evidence.description|truncatewords:30 }}</p>
                  <p class="text-muted mb-0">
                    <small>
                      {{ evidence.get_evidence_type_display }} | 
                      {{ evidence.upload_date|date:"M d, Y" }}
                    </small>
                  </p>
                  {% if evidence.file %}
                  <a href="{{ evidence.file.url }}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
                    View File
                  </a>
                  {% endif %}
                </div>
                <div class="col-md-4 text-right">
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-success btn-assessment mr-2">
                      <input type="radio" name="evidence_{{ evidence.id }}" 
                             value="competent" 
                             data-evidence-id="{{ evidence.id }}"> 
                      Competent
                    </label>
                    <label class="btn btn-outline-danger btn-assessment">
                      <input type="radio" name="evidence_{{ evidence.id }}" 
                             value="not_competent" 
                             data-evidence-id="{{ evidence.id }}">
                      Not Competent
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="text-center py-4">
            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
            <p class="text-muted">No evidence artifacts found.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Competency Assessment -->
    <div class="card mb-4 fade-in">
      <div class="card-header">
        <h6 class="mb-0">Competency Assessment</h6>
      </div>
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Competency Area</th>
              <th>Description</th>
              <th>Assessment</th>
            </tr>
          </thead>
          <tbody>
            {% for competency in competencies %}
            <tr>
              <td>{{ competency.name }}</td>
              <td>{{ competency.criteria|truncatewords:25 }}</td>
              <td class="text-center">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input competency-checkbox" 
                         id="comp_{{ competency.id }}"
                         data-competency-id="{{ competency.id }}">
                  <label class="custom-control-label" for="comp_{{ competency.id }}">
                    Mark as Competent
                  </label>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="text-center py-4">
                <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                <p class="text-muted">No competencies defined.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Reflections -->
    <div class="card mb-4 fade-in">
      <div class="card-header">
        <h6 class="mb-0">Learning Reflections</h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for reflection in reflections %}
          <div class="col-lg-6 mb-4">
            <div class="card h-100 border-left-info">
              <div class="card-body">
                <h6 class="card-title text-primary">{{ reflection.title }}</h6>
                <p class="card-text">{{ reflection.content|truncatewords:40 }}</p>
                <div class="mt-auto">
                  <small class="text-muted">
                    {{ reflection.get_unit_display }}<br>
                    {{ reflection.date|date:"M d, Y" }}
                  </small>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12 text-center py-4">
            <i class="fas fa-brain fa-3x text-muted mb-3"></i>
            <p class="text-muted">No reflections found.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Overall Assessment -->
    <div class="card border-warning fade-in">
      <div class="card-header bg-warning">
        <h5 class="card-title mb-0">Final Assessment</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="form-group">
              <label class="h5">Overall Assessment Result</label>
              <div class="mt-2">
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" id="overall_competent" name="overallResult" value="competent" 
                         class="custom-control-input" disabled>
                  <label class="custom-control-label text-success h5" for="overall_competent">
                    COMPETENT
                  </label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" id="overall_not_competent" name="overallResult" value="not_competent" 
                         class="custom-control-input" disabled>
                  <label class="custom-control-label text-danger h5" for="overall_not_competent">
                    NOT COMPETENT
                  </label>
                </div>
              </div>
              <small id="assessmentHelp" class="form-text text-muted">
                Complete all evidence assessments to enable final submission
              </small>
            </div>
          </div>
          <div class="col-md-4 text-right">
            <button type="button" class="btn btn-success btn-lg px-4 save-btn" id="submitBtn" onclick="submitAssessment()" disabled>
              Submit Assessment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="container">
      <p class="mb-0">xulttech Tecade</p>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    let totalEvidence = {{ evidence_list|length }};
    let assessedEvidence = 0;

    // Dark mode toggle
    document.getElementById('darkModeToggle').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const icon = this.querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
      }
    });

    // Show modal on page load
    $(document).ready(function() {
      $('#assessorModal').modal('show');
    });

    // Start assessment
    $('#startAssessmentBtn').on('click', function() {
      const assessorName = $('#assessorName').val();
      const assessmentDateTime = $('#assessmentDateTime').val();
      
      if (!assessorName || !assessmentDateTime) {
        alert('Please fill all assessor information');
        return;
      }

      // Store assessment data
      const assessmentData = {
        assessorName: assessorName,
        assessmentDateTime: assessmentDateTime,
        traineeName: "{{ trainee.get_full_name }}",
        traineeNumber: "{{ trainee.username }}",
        evidenceAssessments: {},
        competencyAssessments: {},
        overallResult: null,
        submitted: false
      };
      
      localStorage.setItem('portfolioAssessment', JSON.stringify(assessmentData));
      
      // Update display
      $('#currentAssessor').html('Assessor: ' + assessorName);
      $('#assessmentTime').html(new Date(assessmentDateTime).toLocaleString());
      $('#assessmentTimeDisplay').text(new Date(assessmentDateTime).toLocaleString());
      
      // Hide modal and show content
      $('#assessorModal').modal('hide');
      $('#assessmentContent').fadeIn();
      
      updateProgress();
      
      alert('Assessment session for {{ trainee.get_full_name }} ({{ trainee.username }}) has started!');
    });

    function toggleView(viewType) {
      const container = $('#evidenceContainer');
      $('.view-toggle').removeClass('active');
      
      if (viewType === 'grid') {
        container.removeClass('list-view').addClass('grid-view');
        container.html(`<div class="row">${getGridView()}</div>`);
        $(event.target).closest('.view-toggle').addClass('active');
      } else {
        container.removeClass('grid-view').addClass('list-view');
        container.html(getListView());
        $(event.target).closest('.view-toggle').addClass('active');
      }
    }

    function getGridView() {
      return `{% for evidence in evidence_list %}
        <div class="col-lg-6 col-xl-4 mb-4">
          <div class="evidence-card card h-100">
            <div class="card-body">
              <h6 class="card-title text-primary">{{ evidence.title }}</h6>
              <p class="card-text small">{{ evidence.description|truncatewords:20 }}</p>
              <p class="text-muted small mb-3">
                {{ evidence.get_evidence_type_display }}
              </p>
              {% if evidence.file %}
              <a href="{{ evidence.file.url }}" class="btn btn-sm btn-outline-primary btn-block mb-3" target="_blank">
                View File
              </a>
              {% endif %}
              <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                <label class="btn btn-outline-success btn-sm">
                  <input type="radio" name="evidence_{{ evidence.id }}" value="competent" data-evidence-id="{{ evidence.id }}"> 
                  Competent
                </label>
                <label class="btn btn-outline-danger btn-sm">
                  <input type="radio" name="evidence_{{ evidence.id }}" value="not_competent" data-evidence-id="{{ evidence.id }}">
                  Not Competent
                </label>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}`;
    }

    function getListView() {
      return `{% for evidence in evidence_list %}
        <div class="evidence-card card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="card-title text-primary">{{ evidence.title }}</h5>
                <p class="card-text">{{ evidence.description|truncatewords:30 }}</p>
                <p class="text-muted mb-0">
                  <small>
                    {{ evidence.get_evidence_type_display }} | 
                    {{ evidence.upload_date|date:"M d, Y" }}
                  </small>
                </p>
                {% if evidence.file %}
                <a href="{{ evidence.file.url }}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
                  View File
                </a>
                {% endif %}
              </div>
              <div class="col-md-4 text-right">
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-outline-success btn-assessment mr-2">
                    <input type="radio" name="evidence_{{ evidence.id }}" 
                           value="competent" 
                           data-evidence-id="{{ evidence.id }}"> 
                    Competent
                  </label>
                  <label class="btn btn-outline-danger btn-assessment">
                    <input type="radio" name="evidence_{{ evidence.id }}" 
                           value="not_competent" 
                           data-evidence-id="{{ evidence.id }}">
                    Not Competent
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}`;
    }

    // Track evidence assessments
    $(document).on('change', 'input[type="radio"][name^="evidence_"]', function() {
      const evidenceId = $(this).data('evidence-id');
      const competent = $(this).val() === 'competent';
      
      let assessmentData = JSON.parse(localStorage.getItem('portfolioAssessment') || '{}');
      if (!assessmentData.evidenceAssessments) assessmentData.evidenceAssessments = {};
      
      // Update assessment count
      if (!assessmentData.evidenceAssessments[evidenceId]) {
        assessedEvidence++;
      }
      assessmentData.evidenceAssessments[evidenceId] = competent;
      localStorage.setItem('portfolioAssessment', JSON.stringify(assessmentData));
      
      updateProgress();
    });

    // Track competency assessments
    $(document).on('change', '.competency-checkbox', function() {
      const competencyId = $(this).data('competency-id');
      const competent = $(this).is(':checked');
      
      let assessmentData = JSON.parse(localStorage.getItem('portfolioAssessment') || '{}');
      if (!assessmentData.competencyAssessments) assessmentData.competencyAssessments = {};
      assessmentData.competencyAssessments[competencyId] = competent;
      localStorage.setItem('portfolioAssessment', JSON.stringify(assessmentData));
    });

    function updateProgress() {
      const progress = totalEvidence > 0 ? Math.round((assessedEvidence / totalEvidence) * 100) : 0;
      $('#progressText').text(`${assessedEvidence}/${totalEvidence} Evidence Assessed`);
      $('#progressBar').css('width', `${progress}%`);
      
      // Enable/disable final assessment based on completion
      if (assessedEvidence === totalEvidence && totalEvidence > 0) {
        $('input[name="overallResult"]').prop('disabled', false);
        $('#submitBtn').prop('disabled', false);
        $('#assessmentHelp').text('All evidence assessed. You can now submit the final assessment.');
      } else {
        $('input[name="overallResult"]').prop('disabled', true);
        $('#submitBtn').prop('disabled', true);
        $('#assessmentHelp').text(`Complete all ${totalEvidence} evidence assessments to enable final submission`);
      }
    }

    // Track overall result
    $(document).on('change', 'input[name="overallResult"]', function() {
      let assessmentData = JSON.parse(localStorage.getItem('portfolioAssessment') || '{}');
      assessmentData.overallResult = $(this).val();
      localStorage.setItem('portfolioAssessment', JSON.stringify(assessmentData));
    });

    function submitAssessment() {
      const overallResult = $('input[name="overallResult"]:checked').val();
      
      if (!overallResult) {
        alert('Please select an overall assessment result');
        return;
      }

      let assessmentData = JSON.parse(localStorage.getItem('portfolioAssessment') || '{}');
      assessmentData.submitted = true;
      assessmentData.submissionTime = new Date().toISOString();
      localStorage.setItem('portfolioAssessment', JSON.stringify(assessmentData));
      
      alert('Assessment submitted successfully! The trainee can now view the results in their dashboard.');
    }
  </script>
</body>
</html>