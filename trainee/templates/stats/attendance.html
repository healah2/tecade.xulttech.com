{% extends 'trainee/trainee_main.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}TeCADE - Attendance{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.13.0/dist/index.css" />
<link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<link rel="stylesheet" href="{% static 'dist/css/AdminLTE.min.css' %}">
<link rel="stylesheet" href="{% static 'dist/css/skins/_all-skins.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/iCheck/flat/blue.css' %}">
<link rel="stylesheet" href="{% static 'plugins/morris/morris.css' %}">
<link rel="stylesheet" href="{% static 'plugins/jvectormap/jquery-jvectormap-1.2.2.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datepicker/datepicker3.css' %}">
<link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker-bs3.css' %}">
<link rel="stylesheet" href="{% static 'plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
<style>
.attendance-container {
    padding: 20px;
}
.attendance-header {
    background: #daf8cb;
    padding: 8px;
    border-radius: 2px;
    margin-bottom: 16px;
}
.countdown-urgent {
    background-color: #f56954;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
    animation: pulse 1.5s infinite;
}
.countdown-warning {
    background-color: #f39c12;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
}
.countdown-normal {
    background-color: #00a65a;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
}
.status-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
}
.status-present {
    background-color: #00a65a;
    color: white;
}
.status-absent {
    background-color: #dd4b39;
    color: white;
}
.status-late {
    background-color: #f39c12;
    color: white;
}
.status-excused {
    background-color: #00c0ef;
    color: white;
}
.attendance-present {
    background-color: #00a65a !important;
    color: white !important;
}
.attendance-absent {
    background-color: #dd4b39 !important;
    color: white !important;
}
.attendance-late {
    background-color: #f39c12 !important;
    color: white !important;
}
.attendance-excused {
    background-color: #00c0ef !important;
    color: white !important;
}
#attendance-calendar {
    min-height: 400px;
}
.info-box-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}
.attendance-meta {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 15px;
}
.meta-item {
    flex: 1;
    min-width: 200px;
    margin-right: 15px;
    margin-bottom: 10px;
}
.meta-item:last-child {
    margin-right: 0;
}
@media (max-width: 768px) {
    .attendance-meta {
        flex-direction: column;
    }
    .meta-item {
        margin-right: 0;
    }
}
/* Notification System */
.notification-container {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 350px;
    z-index: 9999;
}
.notification {
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    overflow: hidden;
}
.notification-progress {
    height: 4px;
    width: 100%;
    background: #f4f4f4;
}
.notification-progress-bar {
    height: 100%;
    width: 100%;
    background: #3c8dbc;
    animation: progressBar 8s linear;
}
@keyframes progressBar {
    0% { width: 100%; }
    100% { width: 0%; }
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
/* Empty state styles */
.empty-state {
    text-align: center;
    padding: 40px 0;
    color: #777;
}
.empty-state i {
    font-size: 60px;
    margin-bottom: 15px;
    color: #ddd;
}
.empty-state h3 {
    font-size: 20px;
    margin-bottom: 10px;
}
.empty-state p {
    font-size: 14px;
}
.chart-empty {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 250px;
    color: #999;
    font-style: italic;
}
</style>
{% endblock %}

{% block page_title %}My Attendance{% endblock %}
{% block page_subtitle %}
  Track and manage your attendance records
{% endblock %}

{% block breadcrumb %}
  <li><a href="{% url 'trainee:trainee_dashboard' %}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
  <li class="active">Attendance</li>
{% endblock %}

{% block main_content %}
<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<div class="attendance-container">
    <div class="attendance-header">
        <h3>My Attendance Records</h3>
        <p>View your attendance history, statistics, and request excused absences</p>
    </div>

    <!-- Stats Overview -->
    <div class="row">
        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-green"><i class="fa fa-calendar-check-o"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Overall Attendance</span>
                    <span class="info-box-number" id="overall-attendance">--</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-aqua"><i class="fa fa-calendar"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">This Month</span>
                    <span class="info-box-number" id="monthly-attendance">--</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-yellow"><i class="fa fa-exclamation-triangle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Absences Left</span>
                    <span class="info-box-number" id="absences-left">--</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-red"><i class="fa fa-clock-o"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Late Arrivals</span>
                    <span class="info-box-number" id="late-count">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Attendance Calendar -->
        <div class="col-md-8">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Attendance Calendar</h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" id="prev-month"><i class="fa fa-chevron-left"></i></button>
                        <button class="btn btn-box-tool" id="next-month"><i class="fa fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <div id="attendance-calendar"></div>
                </div>
            </div>
        </div>

        <!-- Quick Stats & Actions -->
        <div class="col-md-4">
            <!-- Notification Panel -->
            <div class="box box-warning">
                <div class="box-header with-border">
                    <h3 class="box-title">Notifications</h3>
                </div>
                <div class="box-body">
                    <div id="attendance-notifications">
                        <div class="alert alert-info">No notifications at this time</div>
                    </div>
                </div>
            </div>

            <!-- Excuse Request -->
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">Request Absence Excuse</h3>
                </div>
                <div class="box-body">
                    <p>Submit a request for an excused absence with supporting documentation.</p>
                    <button class="btn btn-primary btn-block" data-toggle="modal" data-target="#excuseModal">
                        <i class="fa fa-paper-plane"></i> Submit Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance History -->
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Attendance History</h3>
                    <div class="box-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" name="table_search" class="form-control pull-right" placeholder="Search" id="attendance-search">
                            <div class="input-group-btn">
                                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Session</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Status</th>
                                <th>Trainer</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-history-body">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="fa fa-database"></i>
                                        <h3>No Attendance Records</h3>
                                        <p>Your attendance records will appear here once available.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="box-footer clearfix">
                    <ul class="pagination pagination-sm no-margin pull-right" id="attendance-pagination">
                        <!-- Pagination will be added dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">Monthly Attendance Trend</h3>
                </div>
                <div class="box-body">
                    <div class="chart">
                        <canvas id="attendanceTrendChart" style="height: 250px; width: 100%;"></canvas>
                        <div id="trend-chart-empty" class="chart-empty">
                            <i class="fa fa-bar-chart"></i> No attendance data available for trend analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Attendance Distribution</h3>
                </div>
                <div class="box-body">
                    <canvas id="attendancePieChart" style="height: 250px; width: 100%;"></canvas>
                    <div id="pie-chart-empty" class="chart-empty">
                        <i class="fa fa-pie-chart"></i> No attendance data available for distribution analysis
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Excuse Request Modal -->
<div class="modal fade" id="excuseModal" tabindex="-1" role="dialog" aria-labelledby="excuseModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="excuseModalLabel">Request Excused Absence</h4>
            </div>
            <div class="modal-body">
                <form id="excuseForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="absenceDate">Date of Absence</label>
                        <input type="date" class="form-control" id="absenceDate" required>
                    </div>
                    <div class="form-group">
                        <label for="sessionSelect">Session</label>
                        <select class="form-control" id="sessionSelect" required>
                            <option value="">Select Session</option>
                            <option value="morning">Morning Session</option>
                            <option value="afternoon">Afternoon Session</option>
                            <option value="full">Full Day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reasonText">Reason for Absence</label>
                        <textarea class="form-control" id="reasonText" rows="3" placeholder="Please provide a detailed reason for your absence" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="supportingDocs">Supporting Documentation</label>
                        <input type="file" id="supportingDocs">
                        <p class="help-block">Upload any supporting documents (medical certificate, etc.)</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitExcuse">Submit Request</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'plugins/jQuery/jQuery-2.1.4.min.js' %}"></script>
<script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'plugins/fastclick/fastclick.min.js' %}"></script>
<script src="{% static 'dist/js/app.min.js' %}"></script>
<script src="{% static 'plugins/sparkline/jquery.sparkline.min.js' %}"></script>
<script src="{% static 'plugins/jvectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
<script src="{% static 'plugins/jvectormap/jquery-jvectormap-world-mill-en.js' %}"></script>
<script src="{% static 'plugins/slimScroll/jquery.slimscroll.min.js' %}"></script>
<script src="{% static 'plugins/chartjs/Chart.min.js' %}"></script>
<script src="{% static 'dist/js/pages/dashboard2.js' %}"></script>
<script src="{% static 'dist/js/demo.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.13.0/dist/index.js" type="module"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Notification system
function showNotification(message, type) {
    const notificationContainer = document.getElementById('notificationContainer');
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible notification`;
    
    notification.innerHTML = `
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
        <h4><i class="icon fa fa-${type === 'success' ? 'check' : 'info'}"></i> ${type.charAt(0).toUpperCase() + type.slice(1)}</h4>
        <p>${message}</p>
        <div class="notification-progress">
            <div class="notification-progress-bar"></div>
        </div>
    `;
    
    notificationContainer.appendChild(notification);
    
    // Remove notification after 8 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            notificationContainer.removeChild(notification);
        }, 500);
    }, 8000);
}

// Check for submission success message from server
{% if messages %}
    {% for message in messages %}
        showNotification("{{ message }}", "{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}");
    {% endfor %}
{% endif %}

$(document).ready(function() {
    // Initialize variables
    let currentPage = 1;
    const pageSize = 10;
    let totalRecords = 0;
    let allAttendanceData = [];
    let filteredAttendanceData = [];
    let hasAttendanceData = false;
    
    // Initialize calendar
    $('#attendance-calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        defaultDate: moment(),
        editable: false,
        eventLimit: true,
        events: function(start, end, timezone, callback) {
            // Fetch attendance data for the calendar view
            $.ajax({
                url: '{% url "trainee:trainee_attendance_calendar" %}',
                type: 'GET',
                data: {
                    start: start.format('YYYY-MM-DD'),
                    end: end.format('YYYY-MM-DD')
                },
                success: function(response) {
                    callback(response.events);
                    
                    // Show empty state if no events
                    if (response.events.length === 0) {
                        $('#attendance-calendar').append(
                            '<div class="empty-state">' +
                            '<i class="fa fa-calendar"></i>' +
                            '<h3>No Attendance Records</h3>' +
                            '<p>Your attendance records will appear here once available.</p>' +
                            '</div>'
                        );
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching calendar data:', error);
                    $('#attendance-calendar').html(
                        '<div class="empty-state">' +
                        '<i class="fa fa-exclamation-triangle"></i>' +
                        '<h3>Unable to Load Calendar</h3>' +
                        '<p>There was an error loading your attendance calendar.</p>' +
                        '</div>'
                    );
                }
            });
        },
        eventRender: function(event, element) {
            element.popover({
                title: event.title,
                content: event.description,
                trigger: 'hover',
                placement: 'top',
                container: 'body'
            });
        }
    });

    // Navigation buttons for calendar
    $('#prev-month').click(function() {
        $('#attendance-calendar').fullCalendar('prev');
    });
    
    $('#next-month').click(function() {
        $('#attendance-calendar').fullCalendar('next');
    });

    // Load all attendance data
    loadAttendanceData();
    
    // Set up real-time updates via polling
    setInterval(loadAttendanceData, 30000); // Update every 30 seconds
    
    // Initialize charts
    initCharts();
    
    // Handle excuse form submission
    $('#submitExcuse').click(function() {
        submitExcuseRequest();
    });

    // Handle search functionality
    $('#attendance-search').on('keyup', function() {
        const searchText = $(this).val().toLowerCase();
        filterAttendanceData(searchText);
    });

    // Function to load attendance data
    function loadAttendanceData() {
        $.ajax({
            url: '{% url "trainee:trainee_attendance_data" %}',
            type: 'GET',
            success: function(data) {
                // Check if we have any attendance data
                hasAttendanceData = data.history && data.history.length > 0;
                
                updateAttendanceStats(data.stats);
                allAttendanceData = data.history || [];
                filteredAttendanceData = allAttendanceData;
                populateAttendanceHistory(filteredAttendanceData, currentPage);
                updateNotifications(data.notifications);
                updateCharts(data.charts);
            },
            error: function(xhr, status, error) {
                console.error('Error loading attendance data:', error);
                
                // Set default values for stats
                $('#overall-attendance').text('N/A');
                $('#monthly-attendance').text('N/A');
                $('#absences-left').text('N/A');
                $('#late-count').text('N/A');
                
                // Show empty state for history table (already shown by default)
                
                // Show empty state for charts
                $('#trend-chart-empty').show();
                $('#pie-chart-empty').show();
                
                // Update notifications
                $('#attendance-notifications').html(
                    '<div class="alert alert-info">No notifications at this time</div>'
                );
            }
        });
    }
    
    // Function to filter attendance data based on search text
    function filterAttendanceData(searchText) {
        if (searchText) {
            filteredAttendanceData = allAttendanceData.filter(function(record) {
                return (
                    record.date.toLowerCase().includes(searchText) ||
                    record.day.toLowerCase().includes(searchText) ||
                    record.session.toLowerCase().includes(searchText) ||
                    record.status.toLowerCase().includes(searchText) ||
                    record.trainer.toLowerCase().includes(searchText)
                );
            });
        } else {
            filteredAttendanceData = allAttendanceData;
        }
        currentPage = 1; // Reset to first page when filtering
        populateAttendanceHistory(filteredAttendanceData, currentPage);
    }
    
    // Function to update attendance statistics
    function updateAttendanceStats(stats) {
        $('#overall-attendance').text(stats.overall !== undefined ? `${stats.overall}%` : 'N/A');
        $('#monthly-attendance').text(stats.monthly !== undefined ? `${stats.monthly}%` : 'N/A');
        $('#absences-left').text(stats.absences_remaining !== undefined ? 
            `${stats.absences_remaining}/${stats.total_allowable_absences || 10}` : 'N/A');
        $('#late-count').text(stats.late_count !== undefined ? stats.late_count : '0');
    }
    
    // Function to populate attendance history table
    function populateAttendanceHistory(history, page) {
        const tbody = $('#attendance-history-body');
        tbody.empty();
        
        if (!history || history.length === 0) {
            tbody.html(
                '<tr><td colspan="7" class="text-center">' +
                '<div class="empty-state">' +
                '<i class="fa fa-database"></i>' +
                '<h3>No Attendance Records</h3>' +
                '<p>Your attendance records will appear here once available.</p>' +
                '</div></td></tr>'
            );
            $('#attendance-pagination').empty();
            return;
        }
        
        // Calculate pagination
        totalRecords = history.length;
        const totalPages = Math.ceil(totalRecords / pageSize);
        const startIndex = (page - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalRecords);
        const pageData = history.slice(startIndex, endIndex);
        
        // Populate table with data
        pageData.forEach(record => {
            const row = `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.day}</td>
                    <td>${record.session}</td>
                    <td>${record.check_in || 'N/A'}</td>
                    <td>${record.check_out || 'N/A'}</td>
                    <td><span class="label label-${getStatusClass(record.status)}">${record.status}</span></td>
                    <td>${record.trainer}</td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Update pagination
        updatePagination(totalPages, page);
    }
    
    // Function to update pagination controls
    function updatePagination(totalPages, currentPage) {
        const pagination = $('#attendance-pagination');
        pagination.empty();
        
        if (totalPages <= 1) {
            return; // Don't show pagination if only one page
        }
        
        // Previous button
        const prevDisabled = currentPage === 1 ? 'disabled' : '';
        pagination.append(`<li class="${prevDisabled}"><a href="#" data-page="${currentPage - 1}">«</a></li>`);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const active = i === currentPage ? 'active' : '';
            pagination.append(`<li class="${active}"><a href="#" data-page="${i}">${i}</a></li>`);
        }
        
        // Next button
        const nextDisabled = currentPage === totalPages ? 'disabled' : '';
        pagination.append(`<li class="${nextDisabled}"><a href="#" data-page="${currentPage + 1}">»</a></li>`);
        
        // Add click handlers
        pagination.find('a').click(function(e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            if (!isNaN(page)) {
                currentPage = page;
                populateAttendanceHistory(filteredAttendanceData, currentPage);
            }
        });
    }
    
    // Function to get CSS class for status
    function getStatusClass(status) {
        switch(status.toLowerCase()) {
            case 'present': return 'present';
            case 'absent': return 'absent';
            case 'late': return 'late';
            case 'excused': return 'excused';
            default: return 'default';
        }
    }
    
    // Function to update notifications
    function updateNotifications(notifications) {
        const container = $('#attendance-notifications');
        
        if (!notifications || notifications.length === 0) {
            container.html('<div class="alert alert-info">No notifications at this time</div>');
            return;
        }
        
        container.empty();
        
        notifications.forEach(notification => {
            const alert = `
                <div class="alert alert-${notification.level} alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                    <h4><i class="icon fa fa-${notification.icon}"></i> ${notification.title}</h4>
                    ${notification.message}
                </div>
            `;
            container.append(alert);
        });
    }
    
    // Function to initialize charts
    function initCharts() {
        // Initialize chart objects but don't populate with data yet
        window.trendChart = new Chart(
            document.getElementById('attendanceTrendChart').getContext('2d'),
            { type: 'line', data: { labels: [], datasets: [] }, options: {} }
        );
        
        window.pieChart = new Chart(
            document.getElementById('attendancePieChart').getContext('2d'),
            { type: 'pie', data: { labels: [], datasets: [] }, options: {} }
        );
    }
    
    // Function to update charts with data
    function updateCharts(chartData) {
        // Hide empty chart messages initially
        $('#trend-chart-empty').hide();
        $('#pie-chart-empty').hide();
        
        // Update trend chart if data exists
        if (window.trendChart && chartData && chartData.trend && 
            chartData.trend.labels && chartData.trend.labels.length > 0) {
            window.trendChart.data = {
                labels: chartData.trend.labels,
                datasets: [{
                    label: 'Monthly Attendance %',
                    data: chartData.trend.values,
                    backgroundColor: 'rgba(60,141,188,0.2)',
                    borderColor: 'rgba(60,141,188,1)',
                    pointBackgroundColor: 'rgba(60,141,188,1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(60,141,188,1)'
                }]
            };
            window.trendChart.options = {
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }]
                }
            };
            window.trendChart.update();
        } else {
            // Show empty state for trend chart
            $('#trend-chart-empty').show();
        }
        
        // Update pie chart if data exists
        if (window.pieChart && chartData && chartData.distribution && 
            chartData.distribution.labels && chartData.distribution.labels.length > 0) {
            window.pieChart.data = {
                labels: chartData.distribution.labels,
                datasets: [{
                    data: chartData.distribution.values,
                    backgroundColor: ['#00a65a', '#dd4b39', '#f39c12', '#00c0ef']
                }]
            };
            window.pieChart.options = {
                maintainAspectRatio: false,
                legend: {
                    position: 'bottom'
                }
            };
            window.pieChart.update();
        } else {
            // Show empty state for pie chart
            $('#pie-chart-empty').show();
        }
    }
    
    // Function to submit excuse request
    function submitExcuseRequest() {
        const formData = new FormData();
        formData.append('date', $('#absenceDate').val());
        formData.append('session', $('#sessionSelect').val());
        formData.append('reason', $('#reasonText').val());
        
        if ($('#supportingDocs')[0].files[0]) {
            formData.append('document', $('#supportingDocs')[0].files[0]);
        }
        
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        $.ajax({
            url: '{% url "trainee:submit_excuse_request" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#excuseModal').modal('hide');
                showNotification('Excuse request submitted successfully!', 'success');
                $('#excuseForm')[0].reset();
                // Reload data to update notifications
                loadAttendanceData();
            },
            error: function(xhr, status, error) {
                showNotification('Error submitting excuse request: ' + (xhr.responseJSON?.error || error), 'error');
            }
        });
    }
});
</script>
{% endblock %}