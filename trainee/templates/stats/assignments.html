{% extends 'trainee/trainee_main.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}TeCADE - Assignments{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.13.0/dist/index.css" />
<link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<link rel="stylesheet" href="{% static 'dist/css/AdminLTE.min.css' %}">
<link rel="stylesheet" href="{% static 'dist/css/skins/_all-skins.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/iCheck/flat/blue.css' %}">
<link rel="stylesheet" href="{% static 'plugins/morris/morris.css' %}">
<link rel="stylesheet" href="{% static 'plugins/jvectormap/jquery-jvectormap-1.2.2.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datepicker/datepicker3.css' %}">
<link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker-bs3.css' %}">
<link rel="stylesheet" href="{% static 'plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css' %}">
<style>
.assignment-container {
    padding: 20px;
}
.assignment-header {
    background: #daf8cb;
    padding: 8px;
    border-radius: 2px;
    margin-bottom: 16px;
}
.countdown-urgent {
    background-color: #f56954;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
    animation: pulse 1.5s infinite;
}
.countdown-warning {
    background-color: #f39c12;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
}
.countdown-normal {
    background-color: #00a65a;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
}
.status-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
}
.status-submitted {
    background-color: #00a65a;
    color: white;
}
.status-graded {
    background-color: #3c8dbc;
    color: white;
}
.status-not-submitted {
    background-color: #dd4b39;
    color: white;
}
.instructions-box {
    background-color: #f8f9fa;
    border-left: 4px solid #3c8dbc;
    padding: 15px;
    margin: 15px 0;
}
.objectives-list {
    padding-left: 20px;
}
.objectives-list li {
    margin-bottom: 5px;
}
.submission-history {
    background-color: #f4f4f4;
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
}
.rubric-table {
    width: 100%;
    margin: 15px 0;
}
.rubric-table th {
    background-color: #e1e1e1;
}
.file-upload-box {
    border: 2px dashed #ccc;
    padding: 20px;
    text-align: center;
    margin: 15px 0;
    cursor: pointer;
}
.file-upload-box:hover {
    border-color: #3c8dbc;
    background-color: #f9f9f9;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
.assignment-meta {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 15px;
}
.meta-item {
    flex: 1;
    min-width: 200px;
    margin-right: 15px;
    margin-bottom: 10px;
}
.meta-item:last-child {
    margin-right: 0;
}
@media (max-width: 768px) {
    .assignment-meta {
        flex-direction: column;
    }
    .meta-item {
        margin-right: 0;
    }
}
/* Notification System */
.notification-container {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 350px;
    z-index: 9999;
}
.notification {
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    overflow: hidden;
}
.notification-progress {
    height: 4px;
    width: 100%;
    background: #f4f4f4;
}
.notification-progress-bar {
    height: 100%;
    width: 100%;
    background: #3c8dbc;
    animation: progressBar 8s linear;
}
@keyframes progressBar {
    0% { width: 100%; }
    100% { width: 0%; }
}
</style>
{% endblock %}

{% block page_title %}Course Assignments{% endblock %}
{% block page_subtitle %}
  Manage and submit your assignments
{% endblock %}

{% block breadcrumb %}
  <li><a href="{% url 'trainee:trainee_dashboard' %}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
  <li class="active">Assignments</li>
{% endblock %}

{% block main_content %}
<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<div class="assignment-container">
    <div class="assignment-header">
        <h3>My Assignments</h3>
        <p>View, manage, and submit your course assignments</p>
    </div>

    {% if assignments %}
        {% for assignment in assignments %}
            {% if assignment.is_active %}
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-file-text-o"></i> {{ assignment.title }}</h3>
                    <div class="box-tools pull-right">
                        <span class="label label-primary">{{ assignment.course.name }}</span>
                    </div>
                </div>
                <div class="box-body">
                    <div class="assignment-meta">
                        <div class="meta-item">
                            <p><strong><i class="fa fa-user"></i> Instructor:</strong> {{ assignment.instructor_name }}</p>
                            <p><strong><i class="fa fa-envelope"></i> Email:</strong> {{ assignment.instructor_email }}</p>
                        </div>
                        <div class="meta-item">
                            <p><strong><i class="fa fa-clock-o"></i> Due Date:</strong> {{ assignment.due_date|date:"F j, Y, g:i a" }}</p>
                            <p><strong>Time Remaining:</strong> <span class="countdown-normal" id="countdown-{{ assignment.id }}"></span></p>
                        </div>
                        <div class="meta-item">
                            <p><strong><i class="fa fa-star"></i> Points:</strong> {{ assignment.max_points }}</p>
                            <p><strong>Status:</strong> 
                                {% for key, submission in submissions_dict.items %}
                                    {% if key == assignment.id %}
                                        <span class="status-badge status-{{ submission.status|lower }}">{{ submission.status }}</span>
                                    {% endif %}
                                {% empty %}
                                    <span class="status-badge status-not-submitted">Not Submitted</span>
                                {% endfor %}
                            </p>
                        </div>
                    </div>

                    <div class="instructions-box">
                        <h4><i class="fa fa-info-circle"></i> Description</h4>
                        <p>{{ assignment.description }}</p>
                    </div>

                    <div class="instructions-box">
                        <h4><i class="fa fa-list-alt"></i> Instructions</h4>
                        <p>{{ assignment.instructions }}</p>
                    </div>

                    {% if assignment.learning_objectives %}
                    <div class="box box-info">
                        <div class="box-header with-border">
                            <h3 class="box-title"><i class=""></i> Learning Objectives</h3>
                        </div>
                        <div class="box-body">
                            <div class="learning-objectives">
                                {{ assignment.learning_objectives|linebreaks }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if assignment.rubric %}
                    <div class="box box-warning">
                        <div class="box-header with-border">
                            <h3 class="box-title"><i class="fa fa-check-square"></i> Grading Logic</h3>
                        </div>
                        <div class="box-body">
                            <div class="rubric-content">
                                {{ assignment.rubric|linebreaks }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Submission Form -->
                    {% if not submissions_dict|get_item:assignment.id %}
                    <div class="box box-success">
                        <div class="box-header with-border">
                            <h3 class="box-title"><i class="fa fa-paper-plane"></i> Submit Assignment</h3>
                        </div>
                        <div class="box-body">
                            <form method="POST" enctype="multipart/form-data" action="{% url 'trainee:submit_assignment' assignment.id %}" id="form-{{ assignment.id }}">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Upload File (optional):</label>
                                    <div class="file-upload-box" onclick="document.getElementById('file-{{ assignment.id }}').click()">
                                        <i class="fa fa-cloud-upload fa-2x"></i>
                                        <p>Click to browse or drag and drop files here</p>
                                        <input type="file" name="file_upload" id="file-{{ assignment.id }}" style="display: none;" onchange="previewFile(this, 'preview-{{ assignment.id }}')">
                                    </div>
                                    <div id="preview-{{ assignment.id }}"></div>
                                </div>
                                <div class="form-group">
                                    <label>Short Answer (optional):</label>
                                    <textarea name="short_text" class="form-control" rows="5" placeholder="Type your answer here..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fa fa-send"></i> Submit Assignment</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="box box-solid box-success submission-history">
                        <div class="box-header with-border">
                            <h3 class="box-title"><i class="fa fa-check-circle"></i> Your Submission</h3>
                        </div>
                        <div class="box-body">
                            {% with submissions_dict|get_item:assignment.id as sub %}
                                {% if sub.file_upload %}
                                <p><strong><i class="fa fa-file"></i> File:</strong> <a href="{{ sub.file_upload.url }}" target="_blank" class="btn btn-default btn-sm">{{ sub.file_upload.name|truncatechars:30 }}</a></p>
                                {% endif %}
                                {% if sub.short_text %}
                                <p><strong><i class="fa fa-align-left"></i> Text Submission:</strong></p>
                                <div class="well well-sm">{{ sub.short_text }}</div>
                                {% endif %}
                                <p><strong><i class="fa fa-clock-o"></i> Submitted at:</strong> {{ sub.submitted_at|date:"F j, Y, g:i a" }}</p>
                                {% if sub.status == "Graded" %}
                                    <div class="alert alert-success">
                                        <h4><i class="fa fa-star"></i> Graded: {{ sub.grade }}/{{ assignment.max_points }}</h4>
                                        {% if sub.admin_feedback %}
                                        <p><strong>Feedback:</strong> {{ sub.admin_feedback }}</p>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div class="box box-solid box-info">
            <div class="box-body text-center">
                <i class="fa fa-folder-open-o fa-3x"></i>
                <h3>No Active Assignments</h3>
                <p>You don't have any active assignments at the moment. Check back later for new assignments.</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'plugins/jQuery/jQuery-2.1.4.min.js' %}"></script>
<script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'plugins/fastclick/fastclick.min.js' %}"></script>
<script src="{% static 'dist/js/app.min.js' %}"></script>
<script src="{% static 'plugins/sparkline/jquery.sparkline.min.js' %}"></script>
<script src="{% static 'plugins/jvectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
<script src="{% static 'plugins/jvectormap/jquery-jvectormap-world-mill-en.js' %}"></script>
<script src="{% static 'plugins/slimScroll/jquery.slimscroll.min.js' %}"></script>
<script src="{% static 'plugins/chartjs/Chart.min.js' %}"></script>
<script src="{% static 'dist/js/pages/dashboard2.js' %}"></script>
<script src="{% static 'dist/js/demo.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.13.0/dist/index.js" type="module"></script>
<script>
// Notification system
function showNotification(message, type) {
    const notificationContainer = document.getElementById('notificationContainer');
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible notification`;
    
    notification.innerHTML = `
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
        <h4><i class="icon fa fa-${type === 'success' ? 'check' : 'info'}"></i> ${type.charAt(0).toUpperCase() + type.slice(1)}</h4>
        <p>${message}</p>
        <div class="notification-progress">
            <div class="notification-progress-bar"></div>
        </div>
    `;
    
    notificationContainer.appendChild(notification);
    
    // Remove notification after 8 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            notificationContainer.removeChild(notification);
        }, 500);
    }, 8000);
}

// Check for submission success message from server
{% if messages %}
    {% for message in messages %}
        showNotification("{{ message }}", "{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}");
    {% endfor %}
{% endif %}

// Check for assignments due in less than an hour
{% for assignment in assignments %}
    var countDownDate{{ assignment.id }} = new Date("{{ assignment.due_date|date:'Y-m-d H:i:s' }}").getTime();
    var x{{ assignment.id }} = setInterval(function() {
        var now = new Date().getTime();
        var distance = countDownDate{{ assignment.id }} - now;
        
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        var countdownElement = document.getElementById("countdown-{{ assignment.id }}");
        
        if (distance < 0) {
            clearInterval(x{{ assignment.id }});
            countdownElement.innerHTML = "EXPIRED";
            countdownElement.className = "countdown-urgent";
        } else {
            countdownElement.innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
            
            // Change style based on remaining time
            if (days < 1) {
                countdownElement.className = "countdown-urgent";
                
                // Show notification if less than 1 hour remaining (only once)
                if (hours === 0 && minutes < 60 && !localStorage.getItem('notified-{{ assignment.id }}')) {
                    showNotification("Assignment '{{ assignment.title }}' is due in less than 1 hour!", "warning");
                    localStorage.setItem('notified-{{ assignment.id }}', 'true');
                }
            } else if (days < 3) {
                countdownElement.className = "countdown-warning";
            } else {
                countdownElement.className = "countdown-normal";
            }
        }
    }, 1000);
{% endfor %}

// Form submission handling
{% for assignment in assignments %}
    document.getElementById('form-{{ assignment.id }}')?.addEventListener('submit', function(e) {
        // Show submission notification
        showNotification("Assignment '{{ assignment.title }}' submitted successfully!", "success");
    });
{% endfor %}

function previewFile(input, previewId) {
    var preview = document.getElementById(previewId);
    var file = input.files[0];
    var reader = new FileReader();

    if (file) {
        // Clear previous preview
        preview.innerHTML = '';
        
        // Create file info element
        var fileInfo = document.createElement('div');
        fileInfo.className = 'alert alert-info';
        fileInfo.innerHTML = '<i class="fa fa-file"></i> ' + file.name + ' (' + Math.round(file.size/1024) + ' KB)';
        preview.appendChild(fileInfo);
        
        // Preview image if it's an image file
        if (file.type.match('image.*')) {
            reader.onload = function(e) {
                var img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.marginTop = '10px';
                preview.appendChild(img);
            }
            reader.readAsDataURL(file);
        }
    }
}

// Simulate new assignment notification (for demo purposes)
// In a real application, this would come from the server
setTimeout(() => {
    showNotification("New assignment!! 'Ensure' You have Submitted Your assignments before the due Date No excusses For any Failure Of submission!", "info");
}, 3000);
</script>
{% endblock %}